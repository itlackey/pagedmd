name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  # Skip Puppeteer download during dependency installation
  # We'll use system Chrome instead to avoid 403 errors
  PUPPETEER_SKIP_DOWNLOAD: 'true'
  PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: 'true'

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run ESLint
        run: bun run lint
        continue-on-error: true

      - name: Check Prettier formatting
        run: bun run format:check
        continue-on-error: true

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Configure Puppeteer to use system Chrome
        run: |
          echo "PUPPETEER_EXECUTABLE_PATH=$(which google-chrome-stable)" >> $GITHUB_ENV

      - name: Run tests
        run: bun test

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build
        run: bun run build

      - name: Check build artifacts
        run: |
          test -f dist/cli.js || (echo "Build failed: dist/cli.js not found" && exit 1)
          test -d dist/assets || (echo "Build failed: dist/assets not found" && exit 1)

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run TypeScript compiler
        run: bunx tsc --noEmit

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies with frozen lockfile
        run: bun install --frozen-lockfile

      - name: Run security audit
        run: bun audit || true
        continue-on-error: true

      - name: Check for vulnerabilities
        run: |
          echo "Running dependency security audit..."
          bun audit --json > audit-results.json || true
          if [ -f audit-results.json ]; then
            echo "Audit completed. Review audit-results.json for details."
          fi
