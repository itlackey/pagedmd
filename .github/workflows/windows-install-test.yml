name: Test Windows Installation Script

on:
  workflow_dispatch:
    inputs:
      script_ref:
        description: 'Git ref (branch/tag) to test install script from'
        required: false
        default: 'main'
        type: string
  pull_request:
    paths:
      - 'scripts/install.ps1'
      - '.github/workflows/windows-install-test.yml'
  workflow_call:
    inputs:
      script_ref:
        description: 'Git ref (branch/tag) to test install script from'
        required: false
        default: 'main'
        type: string

jobs:
  windows-install:
    name: Windows install test
    runs-on: windows-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.script_ref || github.ref }}

      - name: Run install script
        shell: pwsh
        run: ./scripts/install.ps1

      - name: Verify installation
        shell: pwsh
        run: ./tests/integration/run-install-test.ps1 -SkipInstall

      - name: Upload debug logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: windows-install-debug
          path: |
            ${{ runner.temp }}\*.log
            ${{ env.USERPROFILE }}\.bun\install\debug.log
          if-no-files-found: ignore
          retention-days: 7
